<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Карта АЗС</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .legend { position: absolute; top: 10px; left: 10px; background: #fff; padding: 8px 10px; border-radius: 8px; font-family: system-ui, sans-serif; font-size: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
  .sg { display:inline-block; width:10px; height:10px; margin-right:6px; border-radius:2px; vertical-align:middle; }
  .green{background:#28a745}.red{background:#dc3545}.yellow{background:#ffc107}.grey{background:#6c757d}
  .popup h4{margin:0 0 4px 0;font:600 14px system-ui}
  .btn{padding:6px 10px;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:12px;margin:2px;}
  .btn-yes{background:#28a745}.btn-no{background:#dc3545}
</style>
</head>
<body>
<div id="map"></div>
<div class="legend">
  <div><span class="sg green"></span>Бензин есть</div>
  <div><span class="sg red"></span>Нет бензина</div>
  <div><span class="sg yellow"></span>Старая инфо</div>
  <div><span class="sg grey"></span>Нет данных</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://warygfjgwawdkfpqjldc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcnlnZmpnd2F3ZGtmcHFqbGRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NDkwMTgsImV4cCI6MjA3MzAyNTAxOH0.l95f_H6b49bk6O4k10xtu5FHjg1Iinsyr3tCBFa_-I8";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Инициализация карты
const map = L.map('map', { zoomControl: true }).setView([48.4701, 38.8167], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// Загружаем станции
async function loadStations(){
  let { data, error } = await client.from('stations').select('*');
  if(error){ console.error(error); return; }
  data.forEach(st => {
    const marker = L.marker([st.lat, st.lon]).addTo(map);
    marker.bindPopup(`<h4>${st.name}</h4><div>${st.address || ''}</div>
      <button class="btn btn-yes" onclick="vote(${st.id}, true)">Есть</button>
      <button class="btn btn-no" onclick="vote(${st.id}, false)">Нет</button>`);
  });
}

async function vote(station_id, status){
  let { error } = await client.rpc('submit_vote', { p_station_id: station_id, p_status: status });
  if(error){ alert("Ошибка голосования: " + error.message); return; }
  alert("Голос принят!");
}

loadStations();
</script>
</body>
</html>