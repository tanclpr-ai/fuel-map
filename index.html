<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>АЗС Алчевск — Яндекс (полная версия с голосованием)</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
  <style>
    html, body, #map { height:100%; margin:0; }
    #legendBox {
      position:absolute; left:10px; top:10px; z-index:1000;
      background:#fff; padding:8px 10px; border-radius:8px;
      font:12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    #legendBox .row { display:flex; align-items:center; gap:6px; margin:4px 0; white-space:nowrap; }
    .sg { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .green{background:#28a745} .red{background:#dc3545} .yellow{background:#ffc107} .grey{background:#6c757d}

    .divicon {
      display:flex; gap:6px; background:#ffffffee; padding:6px 8px;
      border-radius:8px; border:1px solid #ddd; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      width:124px; height:44px; box-sizing:border-box;    /* фиксированные размеры рамки */
    }
    .fuelSq {
      width:32px; height:32px; border-radius:0;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:700; font-size:12px;
      border:2px solid #000; user-select:none;
      letter-spacing:.3px;
    }
    .popup h4{ margin:0 0 4px 0; font:600 14px system-ui; }
    .popup small{ color:#666; }
    .rowline{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .count{ margin-left:auto; color:#333; font-size:12px; }
    .sg-inline{ width:10px; height:10px; border-radius:2px; display:inline-block; }
    .btn { padding:6px 10px; border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:12px; }
    .btn.yes{ background:#28a745 } .btn.no{ background:#dc3545 }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="legendBox">
    <div class="row"><span class="sg green"></span>Бензин есть</div>
    <div class="row"><span class="sg red"></span>Нет бензина</div>
    <div class="row"><span class="sg yellow"></span>Старая инфо (≥3ч)</div>
    <div class="row"><span class="sg grey"></span>Нет данных (≥14ч)</div>
  </div>

<script>
(function(){
  var SUPABASE_URL = "https://warygfjgwawdkfpqjldc.supabase.co";
  var SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcnlnZmpnd2F3ZGtmcHFqbGRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NDkwMTgsImV4cCI6MjA3MzAyNTAxOH0.l95f_H6b49bk6O4k10xtu5FHjg1Iinsyr3tCBFa_-I8";

  var CENTER = [48.4701, 38.8167];
  var ZOOM = 13;

  var ICON_W = 124, ICON_H = 44;
  var ICON_OFFSET = [ -Math.round(ICON_W/2), -Math.round(ICON_H/2) ]; // по центру

  function anon(){
    try{
      var k='anon_uuid'; var v=localStorage.getItem(k);
      if(!v){ v=((crypto && crypto.randomUUID)?crypto.randomUUID():(Math.random()+"-"+Date.now())); localStorage.setItem(k,v); }
      return v;
    }catch(e){ return (Math.random()+"-"+Date.now()); }
  }
  var ANON = anon();

  function sb(path, options){
    options = options || {};
    var method = options.method || 'GET';
    var body = options.body ? JSON.stringify(options.body) : null;
    return fetch(SUPABASE_URL + path, {
      method: method,
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
        'Content-Type': 'application/json'
      },
      body: body
    }).then(function(res){
      if(!res.ok){ return res.text().then(function(t){ throw new Error(t); }); }
      return res.json();
    });
  }

  function loadStations(){ return sb('/rest/v1/stations?select=id,name,address,lat,lon'); }
  function loadStatusFor(id){
    return sb('/rest/v1/status_cache?station_id=eq.'+id+'&select=station_id,fuel,status,last_update_ts,pos_60m,neg_60m')
      .then(function(rows){
        var byFuel = { AI92:null, AI95:null, DT:null };
        rows.forEach(function(r){ byFuel[r.fuel]=r; });
        return byFuel;
      });
  }
  function submitVote(id,fuel,yes){
    var payload={ p_station:id, p_fuel:fuel, p_vote:yes, p_anon:ANON, p_user_agent:'yandex' };
    return sb('/rest/v1/rpc/submit_vote',{method:'POST', body:payload});
  }

  function color(s){
    if(s==='green') return '#28a745';
    if(s==='red') return '#dc3545';
    if(s==='yellow') return '#ffc107';
    return '#6c757d';
  }
  function ago(ts){
    if(!ts) return 'нет данных';
    var m = Math.floor((Date.now()- new Date(ts).getTime())/60000);
    if(m<60) return m+' мин назад';
    var h=Math.floor(m/60), mm=m%60; return h+' ч '+mm+' мин назад';
  }

  function ymPlacemarkLayout(st){
    var ai92 = st.AI92 ? color(st.AI92.status) : '#6c757d';
    var ai95 = st.AI95 ? color(st.AI95.status) : '#6c757d';
    var dt   = st.DT   ? color(st.DT.status)   : '#6c757d';
    var html = ''
      + '<div class=\"divicon\">'
      + '<div class=\"fuelSq\" style=\"background:'+ai92+'\" title=\"АИ‑92\">92</div>'
      + '<div class=\"fuelSq\" style=\"background:'+ai95+'\" title=\"АИ‑95\">95</div>'
      + '<div class=\"fuelSq\" style=\"background:'+dt+'\" title=\"ДТ\">ДТ</div>'
      + '</div>';
    return ymaps.templateLayoutFactory.createClass(html);
  }

  function safe(obj, path, def){
    try{
      var parts = path.split('.'); var cur = obj;
      for(var i=0;i<parts.length;i++){ cur = cur[parts[i]]; if(cur===undefined || cur===null) return def; }
      return cur;
    }catch(e){ return def; }
  }

  function popupHTML(s, st){
    var n92 = (safe(st,'AI92.pos_60m',0) || 0) + (safe(st,'AI92.neg_60m',0) || 0);
    var n95 = (safe(st,'AI95.pos_60m',0) || 0) + (safe(st,'AI95.neg_60m',0) || 0);
    var ndt = (safe(st,'DT.pos_60m',0)   || 0) + (safe(st,'DT.neg_60m',0)   || 0);

    return ''+
      '<div class=\"popup\">'+
      '<h4>'+(s.name||'АЗС')+'</h4><small>'+(s.address||'')+'</small>'+
      '<div class=\"rowline\"><b>АИ-92</b><span class=\"sg-inline '+ (safe(st,'AI92.status','grey')) +'\"></span><span>'+ago(safe(st,'AI92.last_update_ts',null))+'</span><span class=\"count\">'+n92+'/ч</span></div>'+
      '<div class=\"rowline\"><b>АИ-95</b><span class=\"sg-inline '+ (safe(st,'AI95.status','grey')) +'\"></span><span>'+ago(safe(st,'AI95.last_update_ts',null))+'</span><span class=\"count\">'+n95+'/ч</span></div>'+
      '<div class=\"rowline\"><b>ДТ</b><span class=\"sg-inline '+ (safe(st,'DT.status','grey')) +'\"></span><span>'+ago(safe(st,'DT.last_update_ts',null))+'</span><span class=\"count\">'+ndt+'/ч</span></div>'+
      '<div class=\"rowline\"><button class=\"btn yes\" onclick=\"window._vote(\''+s.id+'\',\'AI92\',true)\">АИ-92: Есть</button><button class=\"btn no\" onclick=\"window._vote(\''+s.id+'\',\'AI92\',false)\">Нет</button></div>'+
      '<div class=\"rowline\"><button class=\"btn yes\" onclick=\"window._vote(\''+s.id+'\',\'AI95\',true)\">АИ-95: Есть</button><button class=\"btn no\" onclick=\"window._vote(\''+s.id+'\',\'AI95\',false)\">Нет</button></div>'+
      '<div class=\"rowline\"><button class=\"btn yes\" onclick=\"window._vote(\''+s.id+'\',\'DT\',true)\">ДТ: Есть</button><button class=\"btn no\" onclick=\"window._vote(\''+s.id+'\',\'DT\',false)\">Нет</button></div>'+
      '</div>';
  }

  window._vote = function(id,fuel,yes){
    submitVote(id,fuel,yes).then(function(){ alert('Спасибо! Голос учтён.'); location.reload(); })
    .catch(function(e){ alert('Ошибка голосования: '+e.message); console.error(e); });
  };

  ymaps.ready(function(){
    var map = new ymaps.Map('map', { center: CENTER, zoom: ZOOM, controls: ['zoomControl','trafficControl'] });

    loadStations().then(function(stations){
      var promises = stations.map(function(s){
        return loadStatusFor(s.id).then(function(st){
          ['AI92','AI95','DT'].forEach(function(k){
            var r=st[k]; if(!r) return;
            var age = Date.now() - new Date(r.last_update_ts||0).getTime();
            if(!isNaN(age)){
              if(age>=14*3600*1000) r.status='grey';
              else if(age>=3*3600*1000 && (r.status==='green'||r.status==='red')) r.status='yellow';
            }
          });
          return { s:s, st:st };
        });
      });

      Promise.all(promises).then(function(list){
        var points=[];
        list.forEach(function(item){
          var s=item.s, st=item.st;
          var layout = ymPlacemarkLayout(st);
          var pm = new ymaps.Placemark([s.lat,s.lon], {}, {
            iconLayout: layout,
            iconShape:{ type:'Rectangle', coordinates:[[0,0],[ICON_W, ICON_H]] },
            iconOffset: ICON_OFFSET,
            hasBalloon:true
          });
          pm.properties.set('balloonContent', popupHTML(s,st));
          map.geoObjects.add(pm);
          points.push([s.lat,s.lon]);
        });
        if(points.length){
          var minLat=points[0][0], maxLat=points[0][0], minLon=points[0][1], maxLon=points[0][1];
          for(var i=0;i<points.length;i++){
            var lat=points[i][0], lon=points[i][1];
            if(lat<minLat)minLat=lat; if(lat>maxLat)maxLat=lat;
            if(lon<minLon)minLon=lon; if(lon>maxLon)maxLon=lon;
          }
          map.setBounds([[minLat,minLon],[maxLat,maxLon]], { checkZoomRange:true, zoomMargin:40 })
            .catch(function(){ map.setCenter(CENTER, ZOOM); });
        } else {
          map.setCenter(CENTER, ZOOM);
        }
      }).catch(function(e){ console.error('Status load failed:', e); });
    }).catch(function(e){ console.error('Stations load failed:', e); });
  });
})();
</script>
</body>
</html>
