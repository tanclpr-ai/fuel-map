<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>АЗС Алчевск — карта (Yandex → OSM fallback)</title>

  <!-- Yandex Maps -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>

  <!-- Leaflet (loaded lazily on fallback) -->
  <link id="leaflet-css" rel="stylesheet" href="" />
  <script id="leaflet-js" src="" defer></script>

  <style>
    html, body, #map { height:100%; margin:0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #legendBox {
      position:absolute; left:10px; top:10px; z-index:1000;
      background:#fff; padding:8px 10px; border-radius:8px;
      font:12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    #legendBox .row { display:flex; align-items:center; gap:6px; margin:4px 0; white-space:nowrap; }
    .sg { width:10px; height:10px; border-radius:2px; display:inline-block; }
    .green{background:#28a745} .red{background:#dc3545} .yellow{background:#ffc107} .grey{background:#6c757d}

    .divicon {
      display:flex; gap:6px; background:#ffffffee; padding:6px 8px;
      border-radius:8px; border:1px solid #ddd; align-items:center;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .fuelSq {
      width:32px; height:32px; border-radius:0;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:700; font-size:12px;
      border:2px solid #000; user-select:none;
      letter-spacing:.3px;
    }
    .popup h4{ margin:0 0 4px 0; font:600 14px system-ui; }
    .popup small{ color:#666; }
    .rowline{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .count{ margin-left:auto; color:#333; font-size:12px; }
    .sg-inline{ width:10px; height:10px; border-radius:2px; display:inline-block; }

    .btn { padding:6px 10px; border:none; border-radius:6px; color:#fff; cursor:pointer; font-size:12px; }
    .btn.yes{ background:#28a745 } .btn.no{ background:#dc3545 }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="legendBox">
    <div class="row"><span class="sg green"></span>Бензин есть</div>
    <div class="row"><span class="sg red"></span>Нет бензина</div>
    <div class="row"><span class="sg yellow"></span>Старая инфо (≥3ч)</div>
    <div class="row"><span class="sg grey"></span>Нет данных (≥14ч)</div>
  </div>

<script>
const SUPABASE_URL = "https://warygfjgwawdkfpqjldc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhcnlnZmpnd2F3ZGtmcHFqbGRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NDkwMTgsImV4cCI6MjA3MzAyNTAxOH0.l95f_H6b49bk6O4k10xtu5FHjg1Iinsyr3tCBFa_-I8";

const CENTER = [48.4701, 38.8167];
const ZOOM = 13;

function anon(){
  try{
    const k='anon_uuid'; let v=localStorage.getItem(k);
    if(!v){ v=(crypto.randomUUID?crypto.randomUUID():(Math.random()+\"-\"+Date.now())); localStorage.setItem(k,v); }
    return v;
  }catch(e){ return (Math.random()+\"-\"+Date.now()); }
}
const ANON = anon();

async function sb(path, {method='GET', body=null}={}){
  const res = await fetch(`${SUPABASE_URL}${path}`, {
    method,
    headers:{ 'apikey':SUPABASE_ANON_KEY, 'Authorization':`Bearer ${SUPABASE_ANON_KEY}`, 'Content-Type':'application/json' },
    body: body ? JSON.stringify(body) : null
  });
  if(!res.ok){ throw new Error(await res.text()); }
  return res.json();
}
async function loadStations(){ return sb('/rest/v1/stations?select=id,name,address,lat,lon'); }
async function loadStatusFor(id){
  const rows = await sb(`/rest/v1/status_cache?station_id=eq.${id}&select=station_id,fuel,status,last_update_ts,pos_60m,neg_60m`);
  const byFuel = { AI92:null, AI95:null, DT:null };
  rows.forEach(r => byFuel[r.fuel]=r);
  return byFuel;
}
async function submitVote(id,fuel,yes){
  const payload={ p_station:id, p_fuel:fuel, p_vote:yes, p_anon:ANON, p_user_agent:'web' };
  return sb('/rest/v1/rpc/submit_vote',{method:'POST', body:payload});
}

function color(s){
  if(s==='green') return '#28a745';
  if(s==='red') return '#dc3545';
  if(s==='yellow') return '#ffc107';
  if(s==='grey') return '#6c757d';
  return '#6c757d';
}
function ago(ts){
  if(!ts) return 'нет данных';
  const m = Math.floor((Date.now()- new Date(ts).getTime())/60000);
  if(m<60) return `${m} мин назад`;
  const h=Math.floor(m/60), mm=m%60; return `${h} ч ${mm} мин назад`;
}

/* ================= YANDEX ================= */
function ymPlacemarkLayout(st){
  const ai92 = st.AI92 ? color(st.AI92.status) : '#6c757d';
  const ai95 = st.AI95 ? color(st.AI95.status) : '#6c757d';
  const dt   = st.DT   ? color(st.DT.status)   : '#6c757d';
  const html = [
    '<div class=\"divicon\">',
    `<div class=\"fuelSq\" style=\"background:${ai92}\" title=\"АИ‑92\">92</div>`,
    `<div class=\"fuelSq\" style=\"background:${ai95}\" title=\"АИ‑95\">95</div>`,
    `<div class=\"fuelSq\" style=\"background:${dt}\" title=\"ДТ\">ДТ</div>`,
    '</div>'
  ].join('');
  return ymaps.templateLayoutFactory.createClass(html);
}
function ymPopupHTML(s, st){
  const n92=(st.AI92?.pos_60m??0)+(st.AI92?.neg_60m??0);
  const n95=(st.AI95?.pos_60m??0)+(st.AI95?.neg_60m??0);
  const ndt=(st.DT?.pos_60m??0)+(st.DT?.neg_60m??0);
  return `
    <div class="popup">
      <h4>${s.name}</h4><small>${s.address||''}</small>
      <div class="rowline"><b>АИ-92</b><span class="sg-inline ${st.AI92?st.AI92.status:'grey'}"></span><span>${ago(st.AI92?.last_update_ts)}</span><span class="count">${n92}/ч</span></div>
      <div class="rowline"><b>АИ-95</b><span class="sg-inline ${st.AI95?st.AI95.status:'grey'}"></span><span>${ago(st.AI95?.last_update_ts)}</span><span class="count">${n95}/ч</span></div>
      <div class="rowline"><b>ДТ</b><span class="sg-inline ${st.DT?st.DT.status:'grey'}"></span><span>${ago(st.DT?.last_update_ts)}</span><span class="count">${ndt}/ч</span></div>
      <div class="rowline"><button class="btn yes" onclick="window._vote('${s.id}','AI92',true)">АИ-92: Есть</button><button class="btn no" onclick="window._vote('${s.id}','AI92',false)">Нет</button></div>
      <div class="rowline"><button class="btn yes" onclick="window._vote('${s.id}','AI95',true)">АИ-95: Есть</button><button class="btn no" onclick="window._vote('${s.id}','AI95',false)">Нет</button></div>
      <div class="rowline"><button class="btn yes" onclick="window._vote('${s.id}','DT',true)">ДТ: Есть</button><button class="btn no" onclick="window._vote('${s.id}','DT',false)">Нет</button></div>
    </div>`;
}

/* ================= LEAFLET ================= */
function loadLeaflet(){
  return new Promise((resolve)=>{
    document.getElementById('leaflet-css').href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
    const s=document.getElementById('leaflet-js');
    s.src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    s.onload=resolve;
  });
}
function lfDivIcon(st){
  const ai92 = st.AI92 ? color(st.AI92.status) : '#6c757d';
  const ai95 = st.AI95 ? color(st.AI95.status) : '#6c757d';
  const dt   = st.DT   ? color(st.DT.status)   : '#6c757d';
  const html = `<div class="divicon">
      <div class="fuelSq" style="background:${ai92}">92</div>
      <div class="fuelSq" style="background:${ai95}">95</div>
      <div class="fuelSq" style="background:${dt}">ДТ</div>
    </div>`;
  return L.divIcon({ html, className:"", iconSize:[124,44], iconAnchor:[40,24], popupAnchor:[0,-28] });
}
function lfPopupHTML(s, st){ return ymPopupHTML(s,st); }

/* ======= Orchestrator: try Yandex then fallback ======= */
(async function(){
  window._vote = async (id,fuel,yes)=>{
    try{ await submitVote(id,fuel,yes); alert('Спасибо! Голос учтён.'); location.reload(); }
    catch(e){ alert('Ошибка голосования: '+e.message); console.error(e); }
  };

  const stations = await loadStations();

  // Normalize statuses by recency for each station
  async function enrich(s){
    const st = await loadStatusFor(s.id);
    for(const k of ['AI92','AI95','DT']){
      const r=st[k]; if(!r) continue;
      const age=Date.now()-new Date(r.last_update_ts||0).getTime();
      if(isFinite(age)){
        if(age>=14*3600*1000) r.status='grey';
        else if(age>=3*3600*1000 && (r.status==='green'||r.status==='red')) r.status='yellow';
      }
    }
    return st;
  }
  const all = await Promise.all(stations.map(async s=>({ s, st: await enrich(s) })));

  let yandexOk = false;
  try {
    await new Promise((res, rej)=> ymaps.ready(res)); // if API failed, this may never fire
    const map = new ymaps.Map('map', { center: CENTER, zoom: ZOOM, controls: ['zoomControl','trafficControl'] });
    const points=[];
    for(const {s,st} of all){
      const layout = ymPlacemarkLayout(st);
      const pm = new ymaps.Placemark([s.lat,s.lon], {}, {
        iconLayout: layout,
        iconShape:{ type:'Rectangle', coordinates:[[ -40,-24 ],[ 140, 44 ]] },
        iconOffset:[-40,-24],
      });
      pm.properties.set('balloonContent', ymPopupHTML(s,st));
      map.geoObjects.add(pm);
      points.push([s.lat,s.lon]);
    }
    if(points.length){
      let minLat=points[0][0], maxLat=points[0][0], minLon=points[0][1], maxLon=points[0][1];
      for(const [lat,lon] of points){ if(lat<minLat)minLat=lat; if(lat>maxLat)maxLat=lat; if(lon<minLon)minLon=lon; if(lon>maxLon)maxLon=lon; }
      map.setBounds([[minLat,minLon],[maxLat,maxLon]], {checkZoomRange:true, zoomMargin:40}).catch(()=>map.setCenter(CENTER,ZOOM));
    } else { map.setCenter(CENTER, ZOOM); }
    yandexOk = true;
  } catch(e){
    console.warn('Yandex init failed, will fallback to Leaflet:', e);
  }

  if(!yandexOk){
    await loadLeaflet();
    const map = L.map('map').setView(CENTER, ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const group = L.featureGroup().addTo(map);

    for(const {s,st} of all){
      const icon = lfDivIcon(st);
      const m = L.marker([s.lat, s.lon], { icon }).addTo(group);
      m.bindPopup(lfPopupHTML(s,st));
    }
    if(group.getLayers().length){
      map.fitBounds(group.getBounds(), { padding:[40,40] });
    }
  }
})();
</script>
</body>
</html>
